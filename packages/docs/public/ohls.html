<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="referrer" content="no-referrer" />
    <title>Start streaming now using OPlayer - Free HTML5 Player</title>
    <meta name="keywords" content="oplayer,hls player,online hls player" />
    <style>
      body {
        margin: 0;
        background-color: #000;
      }

      #oplayer,
      .placeholder {
        width: 100vw;
        height: 100vh;
      }
    </style>
  </head>

  <body>
    <div id="oplayer"></div>

    <script src="https://cdn.jsdelivr.net/npm/@oplayer/core@1.2.33-beta.3/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@oplayer/ui@1.2.36-beta.2/dist/index.min.js"></script>

    <script>
      var hlsScriptCdn = 'https://cdn.jsdelivr.net/npm/@oplayer/hls@latest/dist/index.hls.js'
      var danmakuScriptCdn = 'https://cdn.jsdelivr.net/npm/@oplayer/danmaku@latest/dist/index.min.js'
      var playlistScriptCdn = 'https://cdn.jsdelivr.net/npm/@oplayer/plugins@1.0.10-beta.2/dist/playlist.min.js'
      var chromecastScriptCdn = 'https://cdn.jsdelivr.net/npm/@oplayer/plugins@latest/dist/chromecast.min.js'

      var query = document.location.search.substring(1)
      var src, poster, subtitle, danmaku, title, watermark
      var playlist = []
      if (query.startsWith('http')) {
        src = query.endsWith('==') ? atob(query.substring(0, query.length - 2)) : safeDecodeURIComponent(query)
      } else {
        var search = new URLSearchParams(document.location.search)
        src = safeDecodeURIComponent(search.get('src'))
        playlist = JSON.parse(safeDecodeURIComponent(search.get('playlist')) || '[]')
        poster = safeDecodeURIComponent(search.get('poster'))
        title = safeDecodeURIComponent(search.get('title'))
        danmaku = safeDecodeURIComponent(search.get('danmaku'))

        subtitle = search.get('subtitle')
          ? {
              source: [
                {
                  name: 'Default',
                  default: true,
                  src: decodeURIComponent(search.get('subtitle')),
                },
              ],
            }
          : undefined

        if (title) document.title = title

        watermark = search.get('watermark')
          ? {
              src: decodeURIComponent(search.get('watermark')),
              style: {
                position: 'absolute',
                top: '10px',
                right: '10px',
                maxWidth: '200px',
                height: 'auto',
              },
            }
          : undefined
      }

      var player = OPlayer.make('#oplayer', {
        source: { src: !playlist.length ? src : undefined, poster, title: title || 'Free HTML5 Player' },
        playbackRate: localStorage.getItem('@oplayer/UserPreferences/speed'),
        volume: localStorage.getItem('@oplayer/UserPreferences/volume'),
      })
        .use([
          OUI({
            keyboard: { global: true },
            slideToSeek: 'always',
            controlBar: { back: 'fullscreen' },
            theme: { watermark },
            subtitle,
            errorBuilder(e, t, builder) {
              builder({
                ...e,
                message: e.message || '' + '\n' + 'Open an issues https://github.com/shiyiya/oplayer/issues/new/choose',
              })
            },
          }),
        ])
        .create()
        .on(console.log)

      var deps = [
        [
          chromecastScriptCdn,
          () => {
            player.applyPlugin(OChromecast)
          },
        ],
      ]

      if (/m3u8(#|\?|$)/.test(src) || playlist.some((it) => /m3u8(#|\?|$)/.test(it.src))) {
        deps.push([
          hlsScriptCdn,
          () => {
            player.applyPlugin(OHls({ forceHLS: true }))
          },
        ])
      }

      if (/.mpd(#|\?|$)/i.test(src) || playlist.some((it) => /.mpd(#|\?|$)/i.test(it.src))) {
        deps.push(['https://cdn.jsdelivr.net/npm/@oplayer/dash@latest/dist/index.min.js', () => {}])
        deps.push([
          'https://cdn.dashjs.org/latest/dash.all.min.js',
          () => {
            const dash = ODash()
            dash.constructor.library = dashjs
            player.applyPlugin(dash)
          },
        ])
      }

      if (playlist.length) {
        deps.push([
          playlistScriptCdn,
          () => {
            player.applyPlugin(
              new OPlaylist({
                initialIndex: 0,
                sources: playlist,
              })
            )
          },
        ])
      }

      loadScripts(deps.map(([s]) => s)).then(() => {
        deps.map(([_, fn]) => fn())
        bootstrap()
      })

      function bootstrap() {
        if (danmaku) {
          loadScripts([danmakuScriptCdn]).then((p) => {
            player.applyPlugin(ODanmaku({ source: danmaku }))
          })
        }

        player.on('ratechange', () => {
          if (!player.isSourceChanging)
            localStorage.setItem('@oplayer/UserPreferences/speed', player.playbackRate.toString())
        })

        player.on('volumechange', () => {
          localStorage.setItem('@oplayer/UserPreferences/volume', player.volume.toString())
        })

        if (src) {
          player.on('timeupdate', () => {
            localStorage.setItem(src, player.currentTime.toString())
          })

          var prevTime = localStorage.getItem(src)
          if (prevTime) {
            player.on('loadedmetadata', () => {
              player.seek(prevTime)
            })
          }
        }

        new Promise(() => {
          // https://stackoverflow.com/questions/6370690/media-queries-how-to-target-desktop-tablet-and-mobile
          var $op = document.querySelector('#oplayer')
          // not in iframe
          if (window.self == window.top && $op.clientWidth > 960) {
            $op.firstElementChild.children[1].style.fontSize = $op.clientWidth > 1024 ? '24px' : '20px'
          }
        })
      }

      function safeDecodeURIComponent(uri) {
        return uri ? decodeURIComponent(uri) : undefined
      }

      function loadScripts(scripts) {
        return Promise.all(
          scripts.map((s) => {
            return new Promise((r) => {
              var t = document.body.appendChild(document.createElement('script'))
              t.src = s
              t.onload = r
            })
          })
        )
      }
    </script>
  </body>
</html>
